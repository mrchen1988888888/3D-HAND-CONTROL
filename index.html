<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Strange: Diagnostic Mode</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; }
        
        #input-video { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            opacity: 0; pointer-events: none; z-index: -1; 
            transform: scaleX(-1);
        }

        /* DIAGNOSTIC CONSOLE */
        #console-container {
            position: absolute; top: 10px; left: 10px; width: 300px; height: 200px;
            background: rgba(0, 20, 0, 0.9); border: 1px solid #00ff88;
            padding: 10px; overflow-y: auto; z-index: 100;
            font-size: 11px; color: #00ff88;
            pointer-events: none;
        }
        .log-line { margin-bottom: 2px; border-bottom: 1px solid rgba(0,255,136,0.1); }
        .log-warn { color: #ffaa00; }
        .log-err { color: #ff3333; font-weight: bold; }

        /* Finger Tracker Debugger */
        #finger-tracker {
            position: absolute; width: 20px; height: 20px;
            background: rgba(255, 0, 0, 0.8); border: 2px solid white;
            border-radius: 50%; pointer-events: none; z-index: 50;
            display: none; /* Hidden until hand found */
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px red;
        }

        /* HUD */
        #hud-layer {
            position: absolute; bottom: 40px; width: 100%; text-align: center; pointer-events: none; z-index: 10;
        }
        .spell-status {
            color: #fff; font-size: 14px; background: rgba(0,0,0,0.7); 
            padding: 8px 20px; border-radius: 20px; border: 1px solid #555;
        }

        /* Loader */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 90;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }
        .spinner {
            width: 40px; height: 40px; border: 3px solid #333; 
            border-top: 3px solid #00ff88; border-radius: 50%; 
            animation: spin 1s infinite linear;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <video id="input-video" playsinline webkit-playsinline></video>
    
    <!-- Debug Console -->
    <div id="console-container">
        <div class="log-line">SYSTEM BOOT...</div>
    </div>

    <!-- Visual Tracker for your finger -->
    <div id="finger-tracker"></div>

    <div id="loader"><div class="spinner"></div></div>

    <div id="hud-layer">
        <div class="spell-status" id="status-text">INITIALIZING...</div>
    </div>

    <!-- SOURCES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://unpkg.com/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://unpkg.com/@mediapipe/hands/hands.js"></script>

    <script>
        // --- LOGGER UTILITY ---
        const consoleBox = document.getElementById('console-container');
        function log(msg, type='info') {
            const div = document.createElement('div');
            div.className = 'log-line';
            const time = new Date().toLocaleTimeString().split(' ')[0];
            div.innerHTML = `<span style="opacity:0.5">[${time}]</span> ${msg}`;
            if(type==='err') div.className += ' log-err';
            if(type==='warn') div.className += ' log-warn';
            consoleBox.appendChild(div);
            consoleBox.scrollTop = consoleBox.scrollHeight;
        }

        window.onerror = function(msg) { log("JS ERROR: " + msg, 'err'); }

        // --- 1. THREE.JS ENGINE ---
        log("Starting Graphics Engine...");
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.04);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 14;
        const renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        // Texture
        const cvs = document.createElement('canvas'); cvs.width=32; cvs.height=32;
        const ctx = cvs.getContext('2d');
        const gr = ctx.createRadialGradient(16,16,0,16,16,16);
        gr.addColorStop(0,'white'); gr.addColorStop(0.3,'#ffaa00'); gr.addColorStop(1,'transparent');
        ctx.fillStyle=gr; ctx.fillRect(0,0,32,32);
        const tex = new THREE.CanvasTexture(cvs);

        // Particles
        const COUNT = 5000;
        const geo = new THREE.BufferGeometry();
        const pos = new Float32Array(COUNT*3);
        const vel = new Float32Array(COUNT*3);
        const life = new Float32Array(COUNT);
        
        for(let i=0; i<COUNT; i++) {
            pos[i*3]=9999; life[i]=0;
        }
        geo.setAttribute('position', new THREE.BufferAttribute(pos,3));
        const mat = new THREE.PointsMaterial({size:0.4, map:tex, transparent:true, blending:THREE.AdditiveBlending, depthWrite:false, color:0xffaa00});
        const sys = new THREE.Points(geo, mat);
        scene.add(sys);

        // State
        const State = { r:0, tr:0, charge:0 };

        function animate() {
            requestAnimationFrame(animate);
            State.r += (State.tr - State.r)*0.1;
            sys.rotation.z -= 0.05;

            const p = geo.attributes.position.array;
            for(let i=0; i<COUNT; i++) {
                const idx = i*3;
                life[i] -= 0.02 + Math.random()*0.01;
                
                if(life[i] <= 0) {
                    if(State.r > 0.2) {
                        // Respawn
                        const a = Math.random()*Math.PI*2;
                        const r = State.r + (Math.random()-0.5)*0.5;
                        p[idx] = Math.cos(a)*r;
                        p[idx+1] = Math.sin(a)*r;
                        p[idx+2] = (Math.random()-0.5);
                        
                        // Tangential Velocity
                        const s = 0.1 + Math.random()*0.2;
                        vel[idx] = -Math.sin(a)*s;
                        vel[idx+1] = Math.cos(a)*s;
                        vel[idx+2] = (Math.random()-0.5)*0.05;
                        life[i] = 1;
                    } else {
                        p[idx] = 9999;
                    }
                } else {
                    p[idx] += vel[idx];
                    p[idx+1] += vel[idx+1];
                    p[idx+2] += vel[idx+2];
                }
            }
            geo.attributes.position.needsUpdate=true;
            renderer.render(scene, camera);
        }
        animate();

        // --- 2. AI LOGIC ---
        log("Downloading AI Models (VPN Required)...");
        
        const videoEl = document.getElementById('input-video');
        const statusText = document.getElementById('status-text');
        const fingerTracker = document.getElementById('finger-tracker');
        let lastAng = null;
        let lossTimer = null;

        const hands = new Hands({locateFile: (file) => {
            log(`Fetching: ${file}`);
            return `https://unpkg.com/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        let isLoaded = false;
        hands.onResults(res => {
            if(!isLoaded) {
                isLoaded = true;
                log("AI CORE LOADED!", 'success');
                document.getElementById('loader').style.opacity = 0;
                setTimeout(()=>document.getElementById('loader').style.display='none', 500);
            }

            if(res.multiHandLandmarks.length > 0) {
                const lm = res.multiHandLandmarks[0];
                const tip = lm[8]; // Index finger
                
                // DEBUG: Show finger position
                fingerTracker.style.display = 'block';
                // Convert AI coords (0-1) to Screen coords (px)
                // Note: Video is mirrored using CSS scaleX(-1), but coordinates come raw.
                // We need to flip X to match the visual mirror.
                const x = (1 - tip.x) * window.innerWidth; 
                const y = tip.y * window.innerHeight;
                fingerTracker.style.left = x + 'px';
                fingerTracker.style.top = y + 'px';

                const ang = Math.atan2(y - window.innerHeight/2, x - window.innerWidth/2);

                if(lastAng !== null) {
                    let d = ang - lastAng;
                    if(d > Math.PI) d -= Math.PI*2;
                    if(d < -Math.PI) d += Math.PI*2;
                    
                    // Increased Sensitivity
                    if(Math.abs(d) > 0.02) { 
                        State.charge += Math.abs(d) * 10.0;
                    }
                }
                lastAng = ang;
                State.charge = Math.min(State.charge, 100);
                
                // Update Radius
                State.tr = (State.charge / 100) * 6;

                if(State.charge > 10) {
                    statusText.innerText = `OPENING... ${Math.floor(State.charge)}%`;
                    statusText.style.color = "#ffaa00";
                } else {
                    statusText.innerText = "DETECTED: SPIN FINGER NOW";
                    statusText.style.color = "#00ff88";
                }

                if(lossTimer) clearTimeout(lossTimer);

            } else {
                // Hand Lost
                fingerTracker.style.display = 'none';
                if(!lossTimer) {
                    lossTimer = setTimeout(() => {
                        lastAng = null;
                        State.charge *= 0.9;
                        if(State.charge < 1) State.charge = 0;
                        State.tr = 0;
                        statusText.innerText = "NO HAND DETECTED";
                        statusText.style.color = "#555";
                    }, 200);
                }
            }
        });

        log("Requesting Camera...");
        const cam = new Camera(videoEl, {
            onFrame: async () => await hands.send({image: videoEl}),
            width: 640, height: 480, facingMode: 'user'
        });
        
        cam.start()
           .then(()=> log("Camera Active. Waiting for Hand..."))
           .catch(e=> log(`CAM ERROR: ${e.message}`, 'err'));

        // Watchdog
        setTimeout(() => {
            if(!isLoaded) log("TIMEOUT: Model download stuck. Check Network.", 'err');
        }, 15000);

        window.onresize = () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>

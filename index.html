<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>2025 Particle System (Global)</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #1a0505; font-family: 'Segoe UI', sans-serif; }
        
        body { background: radial-gradient(circle, #2b0a0a 0%, #000000 100%); }

        #input-video { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            opacity: 0; pointer-events: none; z-index: -1; 
            transform: scaleX(-1);
        }
        
        #title-display {
            position: absolute; top: 30px; left: 50%; transform: translateX(-50%);
            font-size: 24px; font-weight: bold; color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            pointer-events: none; z-index: 90;
            text-align: center; letter-spacing: 2px;
            width: 100%;
        }

        #guide-panel {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(40, 0, 0, 0.6); border: 1px solid #ff4444;
            padding: 10px 20px; border-radius: 30px;
            color: #ffcccc; font-size: 13px;
            pointer-events: none; z-index: 90; text-align: center;
            white-space: nowrap;
        }

        /* Áä∂ÊÄÅÊåáÁ§∫ HUD (Â∑¶‰∏äËßí) */
        #hud-status {
            position: absolute; top: 80px; left: 20px;
            font-size: 12px; color: #aaa;
            font-family: monospace;
            z-index: 50;
            background: rgba(0,0,0,0.7);
            padding: 8px 12px;
            border-radius: 4px;
            border-left: 3px solid #666;
            max-width: 200px;
        }

        /* Âä†ËΩΩÈÅÆÁΩ© */
        .loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200;
            transition: opacity 0.5s;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid #ffd700; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <video id="input-video" playsinline webkit-playsinline></video>
    
    <div id="loading" class="loading-mask">
        <div class="spinner"></div>
        <div id="loading-text" style="color:#ffd700; font-size: 14px;">Loading Visuals...</div>
    </div>
    
    <div id="title-display">HAPPY NEW YEAR 2025</div>
    
    <!-- Áä∂ÊÄÅÊòæÁ§∫Âå∫Âüü -->
    <div id="hud-status">
        <div>3D Á≥ªÁªü: <span style="color:#00ff88">Â∞±Áª™</span></div>
        <div id="ai-log">AI Á≥ªÁªü: Á≠âÂæÖÂä†ËΩΩ...</div>
    </div>
    
    <div id="guide-panel">
        üñ±Ô∏è ÁÇπÂáª‰∫§‰∫í | üëå OKÊâãÂäøÂ§ç‰Ωç
    </div>

    <!-- ‰ΩøÁî®ÂõΩÈôÖÊ†áÂáÜÊ∫ê jsdelivr -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <script>
        const aiLog = document.getElementById('ai-log');
        const hudStatus = document.getElementById('hud-status');

        function updateAiStatus(msg, color="#aaa") {
            aiLog.innerHTML = `AI Á≥ªÁªü: <span style="color:${color}">${msg}</span>`;
            if(color === "#ff5555") hudStatus.style.borderLeftColor = "#ff5555";
            if(color === "#00ff88") hudStatus.style.borderLeftColor = "#00ff88";
        }

        // --- 1. Three.js ÂàùÂßãÂåñ (Á´ãÂç≥ÊâßË°å) ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x1a0505, 0.002);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 25;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        // --- 2. ÂàõÂª∫ 2025 Á≤íÂ≠ê ---
        const digitMeshes = [];
        const digitData = [
            { char: "2", x: -9 }, { char: "0", x: -3 }, { char: "2", x: 3 }, { char: "5", x: 9 }
        ];
        const targets = { center: new THREE.Vector3(0, 0, 10) };
        let activeDigitIndex = -1;

        function createTextParticles(text, offsetX) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 200; canvas.height = 200;
            ctx.font = 'bold 160px Arial';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(text, 100, 100);

            const imgData = ctx.getImageData(0, 0, 200, 200);
            const positions = [];
            for (let y = 0; y < 200; y += 4) {
                for (let x = 0; x < 200; x += 4) {
                    if (imgData.data[(y * 200 + x) * 4] > 128) {
                        positions.push((x - 100) * 0.1, (100 - y) * 0.1, (Math.random() - 0.5) * 2);
                    }
                }
            }
            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            const material = new THREE.PointsMaterial({ color: 0xffd700, size: 0.25, transparent: true, opacity: 0.9, blending: THREE.AdditiveBlending });
            const mesh = new THREE.Points(geometry, material);
            mesh.position.set(offsetX, 0, 0);
            mesh.userData = { originalPos: new THREE.Vector3(offsetX, 0, 0) };
            scene.add(mesh);
            return mesh;
        }

        digitData.forEach(d => digitMeshes.push(createTextParticles(d.char, d.x)));

        // --- 3D Âú∫ÊôØÂä†ËΩΩÂÆåÊØïÔºåÁ´ãÂç≥ÁßªÈô§ÈÅÆÁΩ© ---
        const loadingMask = document.getElementById('loading');
        setTimeout(() => {
            loadingMask.style.opacity = '0';
            setTimeout(()=> loadingMask.style.display = 'none', 500);
        }, 1000); // 1ÁßíÂêéÂº∫Âà∂ËøõÂÖ•Ôºå‰∏çÁ≠âAI

        // --- 3. ‰∫§‰∫í ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        raycaster.params.Points.threshold = 1.0;

        function handleInput(x, y) {
            mouse.x = (x / window.innerWidth) * 2 - 1;
            mouse.y = -(y / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(digitMeshes);
            if (intersects.length > 0) {
                const index = digitMeshes.indexOf(intersects[0].object);
                if (index !== -1 && index !== activeDigitIndex) {
                    activeDigitIndex = index;
                }
            }
        }
        window.addEventListener('click', e => handleInput(e.clientX, e.clientY));
        window.addEventListener('touchstart', e => { e.preventDefault(); handleInput(e.touches[0].clientX, e.touches[0].clientY); }, {passive: false});
        function resetAll() { if (activeDigitIndex === -1) return; activeDigitIndex = -1; }

        // --- 4. Âä®Áîª ---
        function animate() {
            requestAnimationFrame(animate);
            digitMeshes.forEach((mesh, i) => {
                mesh.rotation.y += 0.005;
                let targetPos, targetScale, targetOpacity;
                if (activeDigitIndex === -1) {
                    targetPos = mesh.userData.originalPos; targetScale = 1.0; targetOpacity = 0.9;
                } else {
                    if (i === activeDigitIndex) { targetPos = targets.center; targetScale = 2.0; targetOpacity = 1.0; } 
                    else { targetPos = mesh.userData.originalPos.clone().multiplyScalar(5); targetScale = 0.1; targetOpacity = 0.0; }
                }
                mesh.position.lerp(targetPos, 0.08);
                const s = mesh.scale.x + (targetScale - mesh.scale.x) * 0.08;
                mesh.scale.set(s,s,s);
                mesh.material.opacity += (targetOpacity - mesh.material.opacity) * 0.1;
            });
            renderer.render(scene, camera);
        }
        animate();

        // --- 5. AI Á≥ªÁªü (ÂºÇÊ≠•Âä†ËΩΩÔºåÂõΩÈôÖÊ∫ê) ---
        updateAiStatus("Ê≠£Âú®ËøûÊé• MediaPipe...", "#ffaa00");

        const videoElement = document.getElementById('input-video');
        let lastOkTime = 0;

        // ‰ΩøÁî® jsdelivr
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        
        hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        
        hands.onResults((results) => {
            // ‰∏ÄÊó¶ÊúâÁªìÊûúËøîÂõûÔºåËØ¥Êòé AI Ê≠£Â∏∏Â∑•‰Ωú
            if (aiLog.innerText.includes("ËøûÊé•") || aiLog.innerText.includes("‰∏ãËΩΩ")) {
                updateAiStatus("ËøêË°å‰∏≠ (OKÊâãÂäøÂèØÁî®)", "#00ff88");
            }

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                const pinch = Math.hypot(lm[4].x-lm[8].x, lm[4].y-lm[8].y) / Math.hypot(lm[0].x-lm[9].x, lm[0].y-lm[9].y) < 0.25;
                const threeUp = lm[12].y < lm[2].y && lm[16].y < lm[2].y && lm[20].y < lm[2].y;
                if (pinch && threeUp) {
                    if (Date.now() - lastOkTime > 1000) {
                        resetAll();
                        updateAiStatus("Ê£ÄÊµãÂà∞Â§ç‰Ωç", "#00ffff");
                        setTimeout(() => updateAiStatus("ËøêË°å‰∏≠", "#00ff88"), 1000);
                        lastOkTime = Date.now();
                    }
                }
            }
        });

        // ÂêØÂä®ÊëÑÂÉèÂ§¥
        updateAiStatus("ËØ∑Ê±ÇÊëÑÂÉèÂ§¥ÊùÉÈôê...");
        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => await hands.send({image: videoElement}),
            width: 480, height: 360, facingMode: 'user'
        });

        cameraUtils.start()
            .then(() => {
                updateAiStatus("ÊëÑÂÉèÂ§¥Â∑≤ÂºÄÔºå‰∏ãËΩΩÊ®°Âûã‰∏≠...", "#ffaa00");
            })
            .catch(e => {
                console.error(e);
                updateAiStatus("ÊëÑÂÉèÂ§¥Â§±Ë¥•: ËØ∑Ê£ÄÊü•ÊùÉÈôê", "#ff5555");
            });

        // Ë∂ÖÊó∂Ê£ÄÊµã
        setTimeout(() => {
            const statusText = aiLog.innerText;
            if(statusText.includes("ËøûÊé•") || statusText.includes("‰∏ãËΩΩ")) {
                updateAiStatus("ËøûÊé•Ë∂ÖÊó∂ (ËØ∑Ê£ÄÊü•ÁΩëÁªú/VPN)", "#ff5555");
            }
        }, 30000); // 30ÁßíË∂ÖÊó∂Âà§Êñ≠

        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
    </script>
</body>
</html>
